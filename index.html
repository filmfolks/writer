<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Text Writer/Editor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            display: flex;
            flex-direction: column;
            height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }
        #toolbar {
            background-color: #333;
            color: white;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            position: relative;
        }
        button {
            background-color: #555;
            color: white;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            margin: 2px;
        }
        button:hover {
            background-color: #777;
        }
        #fullscreen-btn {
            margin-left: auto;
        }
        #editor {
            flex: 1;
            padding: 20px;
            font-size: 16px;
            line-height: 1.5;
            background-color: white;
            border: none;
            outline: none;
            resize: none;
            overflow: auto;
            transition: font-size 0.3s, background-color 0.3s, color 0.3s;
            font-family: 'Courier New', monospace; /* Monospace font inspired by iA Writer */
        }
        #editor:empty:before {
            content: attr(placeholder);
            color: grey;
        }
        #preview {
            display: none;
            flex: 1;
            padding: 20px;
            background-color: white;
            overflow: auto;
        }
        #footer {
            padding: 5px;
            background-color: #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #stats {
            text-align: right;
        }
        #formatting-tools button {
            background-color: #ddd;
            color: black;
            padding: 4px 8px;
            margin: 0 2px;
        }
        #formatting-tools button:hover {
            background-color: #ccc;
        }
        .dark-mode {
            background-color: #222;
            color: #ddd;
        }
        .dark-mode #editor,
        .dark-mode #preview {
            background-color: #333;
            color: #ddd;
        }
        .dark-mode #toolbar {
            background-color: #111;
        }
        .dark-mode button {
            background-color: #444;
        }
        .dark-mode button:hover {
            background-color: #666;
        }
        .dark-mode #footer {
            background-color: #444;
            color: #ddd;
        }
        .dark-mode #formatting-tools button {
            background-color: #555;
            color: #ddd;
        }
        .dark-mode #formatting-tools button:hover {
            background-color: #666;
        }
        .focus-mode #editor:not(:focus) {
            opacity: 0.5;
        }
        .fullscreen #toolbar {
            display: none; /* Hide the entire toolbar bar in full screen */
        }
        .fullscreen #fullscreen-controls {
            display: flex;
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        #fullscreen-controls {
            display: none;
        }
        .fullscreen #fullscreen-controls button {
            padding: 4px 8px; /* Smaller buttons in full screen */
            font-size: 14px;
        }

        /* Mobile-specific styles (applied via class or media query) */
        .mobile #toolbar {
            /* Keep horizontal with wrapping */
            flex-wrap: wrap;
            justify-content: flex-start;
            overflow-x: auto;
        }
        .mobile button {
            padding: 12px 16px; /* Larger buttons for touch */
            font-size: 18px;
            margin: 5px;
        }
        .mobile #footer {
            flex-direction: column;
            align-items: center;
        }
        .mobile #formatting-tools {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .mobile #formatting-tools button {
            padding: 8px 12px;
            font-size: 16px;
            margin: 5px;
        }
        .mobile #editor {
            font-size: 18px; /* Larger text for mobile readability */
            padding: 15px;
        }
        .mobile #stats {
            margin-top: 10px;
        }

        /* Responsive media query for small screens (fallback if JS detection fails) */
        @media (max-width: 768px) {
            #toolbar {
                flex-wrap: wrap;
                justify-content: flex-start;
                overflow-x: auto;
            }
            button {
                padding: 12px 16px;
                font-size: 18px;
                margin: 5px;
            }
            #footer {
                flex-direction: column;
                align-items: center;
            }
            #formatting-tools {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
            }
            #formatting-tools button {
                padding: 8px 12px;
                font-size: 16px;
                margin: 5px;
            }
            #editor {
                font-size: 18px;
                padding: 15px;
            }
            #stats {
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="toolbar">
        <button title="Save" onclick="handleSave()">S</button>
        <button title="Load" onclick="loadText()">L</button>
        <button title="Clear" onclick="clearText()">C</button>
        <button title="Preview" onclick="togglePreview()">P</button>
        <button title="Toggle Dark Mode" onclick="toggleDarkMode()">ðŸŒ™</button>
        <button title="Increase Font Size" onclick="increaseFont()">+</button>
        <button title="Decrease Font Size" onclick="decreaseFont()">-</button>
        <button title="Search and Replace" onclick="searchReplace()">Search/Replace</button>
        <button title="Toggle Focus Mode" onclick="toggleFocusMode()">Focus Mode</button>
        <button title="Undo" onclick="undo()">Undo</button>
        <button title="Redo" onclick="redo()">Redo</button>
        <button title="Toggle Auto Save" onclick="toggleAutoSave()">A</button>
        <button id="fullscreen-btn" title="Toggle Full Screen" onclick="toggleFullScreen()">[ ]</button>
    </div>
    <div id="fullscreen-controls">
        <button title="Toggle Dark Mode" onclick="toggleDarkMode()">ðŸŒ™</button>
        <button title="Toggle Full Screen" onclick="toggleFullScreen()">[ ]</button>
    </div>
    <div id="editor" contenteditable="true" placeholder="Start writing here..."></div>
    <div id="preview"></div>
    <div id="footer">
        <div id="formatting-tools">
            <button title="Bold" onclick="formatText('bold')">B</button>
            <button title="Italic" onclick="formatText('italic')">I</button>
            <button title="Heading 1" onclick="formatText('heading1')">#</button>
            <button title="Heading 2" onclick="formatText('heading2')">##</button>
            <button title="Insert Link" onclick="formatText('link')">Link</button>
            <button title="Insert Image" onclick="formatText('image')">Img</button>
            <button title="Unordered List" onclick="formatText('list')">-</button>
            <button title="Numbered List" onclick="formatText('numberedList')">1.</button>
            <button title="Blockquote" onclick="formatText('quote')">></button>
            <button title="Code" onclick="formatText('code')">Code</button>
            <button title="Insert Table" onclick="formatText('table')">Table</button>
            <button title="Insert Footnote" onclick="formatText('footnote')">Footnote</button>
        </div>
        <div id="stats">Words: 0 | Characters: 0</div>
    </div>

    <script>
        // Detect if user is on mobile browser
        function isMobile() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            return /android|iPad|iPhone|iPod|windows phone/i.test(userAgent) && !window.MSStream;
        }

        // Apply mobile class if detected
        if (isMobile()) {
            document.body.classList.add('mobile');
        }

        let fontSize = 16;
        let history = [];
        let historyIndex = -1;
        let autoSaveInterval = null;
        let isAutoSaveOn = false;

        function updateStats() {
            const text = document.getElementById('editor').innerText;
            const words = text.split(/\s+/).filter(word => word.length > 0).length;
            const chars = text.length;
            document.getElementById('stats').innerText = `Words: ${words} | Characters: ${chars}`;
        }

        function saveToHistory() {
            const text = document.getElementById('editor').innerHTML;
            if (historyIndex < history.length - 1) {
                history = history.slice(0, historyIndex + 1);
            }
            history.push(text);
            historyIndex = history.length - 1;
        }

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                document.getElementById('editor').innerHTML = history[historyIndex];
                updateStats();
            }
        }

        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                document.getElementById('editor').innerHTML = history[historyIndex];
                updateStats();
            }
        }

        function handleSave() {
            const options = 'Choose format:\n1. txt\n2. pdf\n3. fountain\n4. img';
            const choice = prompt(options);
            if (!choice) return;
            const text = document.getElementById('editor').innerText;
            let extension;
            switch (choice) {
                case '1':
                case 'txt':
                    extension = 'txt';
                    break;
                case '2':
                case 'pdf':
                    extension = 'pdf';
                    break;
                case '3':
                case 'fountain':
                    extension = 'fountain';
                    break;
                case '4':
                case 'img':
                    extension = 'png'; // Export as PNG image
                    break;
                default:
                    alert('Invalid choice. Please enter 1, 2, 3, 4, or the format name.');
                    return;
            }
            let filename = `document.${extension}`;
            if (extension === 'txt' || extension === 'fountain') {
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            } else if (extension === 'pdf') {
                const printWindow = window.open('', '_blank');
                printWindow.document.write('<html><head><title>Print to PDF</title></head><body><pre>' + text + '</pre></body></html>');
                printWindow.document.close();
                printWindow.print();
                // Note: After printing, save as PDF from the print dialog.
            } else if (extension === 'png') {
                const editor = document.getElementById('editor');
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const lines = text.split('\n');
                const lineHeight = 20; // Approximate line height
                canvas.width = 800; // Fixed width for image
                canvas.height = lines.length * lineHeight + 40; // Height based on lines
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.font = `${fontSize}px monospace`;
                ctx.fillStyle = 'black';
                lines.forEach((line, index) => {
                    ctx.fillText(line, 20, (index + 1) * lineHeight + 20);
                });
                const url = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
            }
            // Also save to localStorage as before
            localStorage.setItem('savedText', text);
        }

        function loadText() {
            const savedText = localStorage.getItem('savedText');
            if (savedText) {
                document.getElementById('editor').innerText = savedText;
                saveToHistory();
                updateStats();
            } else {
                alert('No saved text found.');
            }
        }

        function clearText() {
            document.getElementById('editor').innerHTML = '';
            saveToHistory();
            updateStats();
        }

        function togglePreview() {
            const preview = document.getElementById('preview');
            const editor = document.getElementById('editor');
            if (preview.style.display === 'none') {
                preview.innerHTML = multiMarkdownToHtml(editor.innerText);
                preview.style.display = 'block';
                editor.style.display = 'none';
            } else {
                preview.style.display = 'none';
                editor.style.display = 'block';
            }
        }

        function multiMarkdownToHtml(text) {
            // Basic MultiMarkdown parser (supports core features; not exhaustive)
            // Headings
            text = text.replace(/^###### (.*$)/gm, '<h6>$1</h6>');
            text = text.replace(/^##### (.*$)/gm, '<h5>$1</h5>');
            text = text.replace(/^#### (.*$)/gm, '<h4>$1</h4>');
            text = text.replace(/^### (.*$)/gm, '<h3>$1</h3>');
            text = text.replace(/^## (.*$)/gm, '<h2>$1</h2>');
            text = text.replace(/^# (.*$)/gm, '<h1>$1</h1>');

            // Bold and Italic
            text = text.replace(/\*\*(.*)\*\*/gm, '<strong>$1</strong>');
            text = text.replace(/\*(.*)\*/gm, '<em>$1</em>');

            // Links and Images
            text = text.replace(/!\[(.*?)\]\((.*?)\)/gm, '<img alt="$1" src="$2" />');
            text = text.replace(/\[(.*?)\]\((.*?)\)/gm, '<a href="$2">$1</a>');

            // Lists
            text = text.replace(/^\s*[-*+] (.*)/gm, '<ul><li>$1</li></ul>');
            text = text.replace(/^\s*\d+\. (.*)/gm, '<ol><li>$1</li></ol>');

            // Blockquotes
            text = text.replace(/^> (.*)/gm, '<blockquote>$1</blockquote>');

            // Code Blocks
            text = text.replace(/``````/gs, '<pre><code>$1</code></pre>');
            text = text.replace(/`(.*?)`/g, '<code>$1</code>');

            // Tables (basic support)
            text = text.replace(/\|(.*?)\|/g, function(match) {
                return match.replace(/\|/g, '</td><td>').replace(/^<\/td>/, '<tr><td>');
            });
            text = text.replace(/<tr><td>(.*?)<\/td><\/tr>/g, '<table><tbody>$&</tbody></table>');

            // Footnotes (basic: [^[note]] becomes <sup>note</sup>)
            text = text.replace(/\[\^(.+?)\]/g, '<sup id="fn-$1"><a href="#fnref-$1">$1</a></sup>');

            // Horizontal Rule
            text = text.replace(/^[-*]{3,}/gm, '<hr>');

            // Line breaks
            text = text.replace(/\n$/gm, '<br />');

            return text;
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
        }

        function increaseFont() {
            fontSize += 2;
            document.getElementById('editor').style.fontSize = `${fontSize}px`;
        }

        function decreaseFont() {
            if (fontSize > 10) {
                fontSize -= 2;
                document.getElementById('editor').style.fontSize = `${fontSize}px`;
            }
        }

        function searchReplace() {
            const search = prompt('Enter text to search:');
            if (!search) return;
            const replace = prompt('Enter replacement text:');
            const editor = document.getElementById('editor');
            editor.innerHTML = editor.innerHTML.replace(new RegExp(search, 'g'), replace);
            saveToHistory();
            updateStats();
        }

        function toggleFocusMode() {
            document.body.classList.toggle('focus-mode');
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable full-screen mode: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        }

        function toggleAutoSave() {
            isAutoSaveOn = !isAutoSaveOn;
            if (isAutoSaveOn) {
                autoSaveInterval = setInterval(() => {
                    const text = document.getElementById('editor').innerText;
                    localStorage.setItem('savedText', text);
                    console.log('Auto-saved to localStorage');
                }, 120000); // 2 minutes = 120000 ms
                alert('Auto-save enabled (every 2 minutes)');
            } else {
                clearInterval(autoSaveInterval);
                alert('Auto-save disabled');
            }
        }

        // Formatting functions
        function formatText(type) {
            const editor = document.getElementById('editor');
            const selection = window.getSelection();
            if (selection.rangeCount) {
                const range = selection.getRangeAt(0);
                const selectedText = range.toString();
                let formattedText = selectedText;

                switch (type) {
                    case 'bold':
                        formattedText = `**${selectedText}**`;
                        break;
                    case 'italic':
                        formattedText = `*${selectedText}*`;
                        break;
                    case 'heading1':
                        formattedText = `# ${selectedText}`;
                        break;
                    case 'heading2':
                        formattedText = `## ${selectedText}`;
                        break;
                    case 'link':
                        const url = prompt('Enter URL:') || 'https://example.com';
                        formattedText = `[${selectedText}](${url})`;
                        break;
                    case 'image':
                        const imgUrl = prompt('Enter image URL:') || 'https://example.com/image.jpg';
                        formattedText = `![${selectedText}](${imgUrl})`;
                        break;
                    case 'list':
                        formattedText = `- ${selectedText}`;
                        break;
                    case 'numberedList':
                        formattedText = `1. ${selectedText}`;
                        break;
                    case 'quote':
                        formattedText = `> ${selectedText}`;
                        break;
                    case 'code':
                        formattedText = `\`${selectedText}\``;
                        break;
                    case 'table':
                        formattedText = '| Header1 | Header2 |\n|---------|---------|\n| Cell1   | Cell2   |';
                        break;
                    case 'footnote':
                        const note = prompt('Enter footnote text:') || 'note';
                        formattedText = `${selectedText}[^${note}]`;
                        break;
                }

                range.deleteContents();
                range.insertNode(document.createTextNode(formattedText));
                saveToHistory();
                updateStats();
            }
        }

        // Handle fullscreen change
        document.addEventListener('fullscreenchange', () => {
            const isFullscreen = !!document.fullscreenElement;
            document.body.classList.toggle('fullscreen', isFullscreen);
            document.getElementById('fullscreen-controls').style.display = isFullscreen ? 'flex' : 'none';
        });

        document.getElementById('editor').addEventListener('input', () => {
            saveToHistory();
            updateStats();
        });

        // Initial save to history
        saveToHistory();
        updateStats();
    </script>
</body>
</html>
